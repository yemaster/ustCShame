<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº‘ç›˜æ–‡ä»¶æµè§ˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css">
  <style>
    :root {
      --primary-color: #0366d6;
      --hover-bg: #f6f8fa;
      --border-color: #e1e4e8;
      --text-secondary: #586069;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      background-color: #f6f8fa;
      color: #24292e;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .container {
      width: 100%;
      max-width: 900px;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      height: fit-content;
      min-height: 500px;
    }

    /* === é¡¶éƒ¨æ  (é¢åŒ…å±‘ + æœç´¢) === */
    .header {
      padding: 12px 16px;
      background: #fcfcfc;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
    }

    /* é¢åŒ…å±‘ */
    .breadcrumb-container {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      flex: 1;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .breadcrumb-item { cursor: pointer; color: var(--primary-color); }
    .breadcrumb-item:hover { text-decoration: underline; }
    .breadcrumb-separator { margin: 0 5px; color: #999; }

    /* æœç´¢æ¡† */
    .search-wrapper {
      position: relative;
      width: 250px;
    }
    .search-input {
      width: 100%;
      padding: 6px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 14px;
      outline: none;
      box-sizing: border-box;
      transition: all 0.2s;
    }
    .search-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.3);
    }

    /* === æ–‡ä»¶åˆ—è¡¨æ ·å¼ === */
    .file-list { list-style: none; margin: 0; padding: 0; }
    .file-item {
      display: flex;
      align-items: center;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background 0.2s;
    }
    .file-item:last-child { border-bottom: none; }
    .file-item:hover { background-color: var(--hover-bg); }
    
    .icon { margin-right: 12px; width: 20px; text-align: center; font-size: 1.2em; flex-shrink: 0;}
    
    .file-info { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
    .file-name { color: var(--primary-color); font-weight: 500; }
    .file-path { font-size: 12px; color: #6a737d; margin-top: 2px; }
    
    .file-item:hover .file-name { text-decoration: underline; }
    .back-item { background-color: #fff9f9; font-weight: bold; }

    /* === README åŒºåŸŸ === */
    .readme-container { padding: 32px; border-top: 1px solid var(--border-color); }
    .readme-title {
      font-size: 12px; color: var(--text-secondary); text-transform: uppercase;
      font-weight: 600; margin-bottom: 10px; padding-bottom: 10px;
      border-bottom: 1px solid #eaecef;
    }

    /* === é¢„è§ˆç•Œé¢æ ·å¼ === */
    .preview-header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }
    .btn {
      padding: 6px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      background: #fafbfc;
      text-decoration: none;
      color: #24292e;
      display: inline-block;
    }
    .btn:hover { background-color: #f3f4f6; }
    .btn-primary { background-color: #2ea44f; color: white; border: 1px solid rgba(27,31,35,.15); }
    .btn-primary:hover { background-color: #2c974b; }
    
    .preview-body { padding: 20px; overflow-x: auto; flex: 1; }
    .preview-image { max-width: 100%; display: block; margin: 0 auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .preview-code { background: #f6f8fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div class="container">
  
  <!-- === è§†å›¾ 1: æ–‡ä»¶åˆ—è¡¨ / æœç´¢ç»“æœ === -->
  <div id="view-list">
    <div class="header">
      <div class="breadcrumb-container" id="breadcrumb">
        <span>/</span>
      </div>
      <div class="search-wrapper">
        <input type="text" id="searchInput" class="search-input" placeholder="å…¨ç›˜æœç´¢..." autocomplete="off">
      </div>
    </div>

    <div class="file-list" id="fileList">
      <div style="padding: 20px; text-align: center; color: #666;">åŠ è½½ä¸­...</div>
    </div>

    <!-- ä»…åœ¨æ™®é€šæµè§ˆæ¨¡å¼ä¸‹æ˜¾ç¤ºçš„ README -->
    <div id="readmeBox" class="readme-container hidden">
      <div class="readme-title">README.md (å½“å‰ç›®å½•)</div>
      <div id="readmeFooter" class="markdown-body"></div>
    </div>
  </div>

  <!-- === è§†å›¾ 2: æ–‡ä»¶é¢„è§ˆ === -->
  <div id="view-preview" class="hidden">
    <div class="header">
      <div class="preview-header-bar">
        <button class="btn" onclick="exitPreview()">â¬… è¿”å›</button>
        <span id="previewTitle" style="font-weight: bold; margin: 0 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">File</span>
        <a id="downloadBtn" class="btn btn-primary" href="#" target="_blank">â¬‡ ä¸‹è½½</a>
      </div>
    </div>
    <div id="previewContent" class="preview-body markdown-body"></div>
  </div>

</div>

<script>
  let rootTree = [];
  let pathStack = []; // å½“å‰æµè§ˆçš„æ–‡ä»¶å¤¹å±‚çº§
  let currentBasePath = ''; 
  let isSearching = false; // æ ‡è®°æ˜¯å¦å¤„äºæœç´¢æ¨¡å¼

  // åˆå§‹åŒ–
  async function init() {
    try {
      const res = await fetch('tree.json');
      rootTree = await res.json();
      renderList();
      
      // ç»‘å®šæœç´¢äº‹ä»¶
      document.getElementById('searchInput').addEventListener('input', (e) => {
        const keyword = e.target.value.trim();
        if (keyword) {
          isSearching = true;
          performSearch(keyword);
        } else {
          isSearching = false;
          renderList();
        }
      });
    } catch (e) {
      document.getElementById('fileList').innerHTML = `<div style="padding:20px; color:red;">æ— æ³•åŠ è½½ tree.json</div>`;
      console.error(e);
    }
  }

  // --- æ ¸å¿ƒæ¸²æŸ“ï¼šåˆ—è¡¨æ¨¡å¼ ---
  function renderList() {
    // ç•Œé¢åˆ‡æ¢
    document.getElementById('view-list').classList.remove('hidden');
    document.getElementById('view-preview').classList.add('hidden');
    
    // å¦‚æœä¸åœ¨æœç´¢æ¨¡å¼ï¼Œæ‰æ›´æ–°é¢åŒ…å±‘å’Œ README
    if (!isSearching) {
      document.getElementById('breadcrumb').style.visibility = 'visible';
      document.getElementById('readmeBox').classList.add('hidden'); // å…ˆéšè—ï¼Œåé¢æ£€æµ‹åˆ°å†æ˜¾ç¤º
    }

    const container = document.getElementById('fileList');
    container.innerHTML = '';

    // è·å–å½“å‰å±‚çº§æ•°æ®
    const nodes = (pathStack.length === 0) ? rootTree : (pathStack[pathStack.length - 1].children || []);
    
    // æ„å»ºå½“å‰è·¯å¾„å­—ç¬¦ä¸²
    currentBasePath = pathStack.map(n => n.name).join('/') + (pathStack.length ? '/' : '');

    // 1. æ¸²æŸ“é¢åŒ…å±‘
    renderBreadcrumb();

    // 2. æ¸²æŸ“â€œè¿”å›ä¸Šä¸€çº§â€
    if (pathStack.length > 0) {
      const backDiv = document.createElement('div');
      backDiv.className = 'file-item back-item';
      backDiv.innerHTML = `<span class="icon">ğŸ”™</span><div class="file-info"><span class="file-name">.. (è¿”å›ä¸Šä¸€çº§)</span></div>`;
      backDiv.onclick = goBackFolder;
      container.appendChild(backDiv);
    }

    // 3. æ’åº
    const sortedNodes = [...nodes].sort((a, b) => {
      if (a.type === b.type) return a.name.localeCompare(b.name);
      return a.type === 'dir' ? -1 : 1;
    });

    if (sortedNodes.length === 0) {
      container.innerHTML += `<div style="padding:20px; text-align:center; color:#999;">å½“å‰æ–‡ä»¶å¤¹ä¸ºç©º</div>`;
    }

    // 4. æ¸²æŸ“æ™®é€šåˆ—è¡¨
    sortedNodes.forEach(node => {
      const el = document.createElement('div');
      el.className = 'file-item';
      const icon = node.type === 'dir' ? 'ğŸ“' : 'ğŸ“„';
      
      el.innerHTML = `
        <span class="icon">${icon}</span>
        <div class="file-info">
          <span class="file-name">${node.name}</span>
        </div>`;

      if (node.type === 'dir') {
        el.onclick = () => enterFolder(node);
      } else {
        el.onclick = () => enterPreview(node, currentBasePath + node.name);
      }
      container.appendChild(el);
    });

    // 5. æ£€æµ‹ README
    handleReadmeInList(nodes);
  }

  // --- æœç´¢é€»è¾‘ ---
  function performSearch(keyword) {
    const container = document.getElementById('fileList');
    const lowerKey = keyword.toLowerCase();
    const results = [];

    // éšè—é¢åŒ…å±‘å’Œ README (æœç´¢ç»“æœé¡µä¸éœ€è¦)
    document.getElementById('breadcrumb').style.visibility = 'hidden';
    document.getElementById('readmeBox').classList.add('hidden');

    // é€’å½’æœç´¢å‡½æ•°
    // parents: è®°å½•çˆ¶èŠ‚ç‚¹æ•°ç»„ï¼Œç”¨äºç‚¹å‡»æ–‡ä»¶å¤¹æ—¶é‡å»ºé¢åŒ…å±‘
    function traverse(nodes, parentPath, parents) {
      nodes.forEach(node => {
        const fullPath = parentPath + node.name;
        
        // åŒ¹é…æˆåŠŸ
        if (node.name.toLowerCase().includes(lowerKey)) {
          results.push({
            node: node,
            path: fullPath,
            parents: [...parents] // å¤åˆ¶çˆ¶çº§é“¾
          });
        }

        // ç»§ç»­é€’å½’
        if (node.type === 'dir' && node.children) {
          traverse(node.children, fullPath + '/', [...parents, node]);
        }
      });
    }

    traverse(rootTree, '', []);

    // æ¸²æŸ“æœç´¢ç»“æœ
    container.innerHTML = '';
    if (results.length === 0) {
      container.innerHTML = `<div style="padding:20px; text-align:center; color:#999;">æ²¡æœ‰æ‰¾åˆ°åŒ…å« "${keyword}" çš„æ–‡ä»¶</div>`;
      return;
    }

    results.forEach(res => {
      const el = document.createElement('div');
      el.className = 'file-item';
      const icon = res.node.type === 'dir' ? 'ğŸ“' : 'ğŸ“„';
      
      // æ˜¾ç¤ºå®Œæ•´è·¯å¾„
      el.innerHTML = `
        <span class="icon">${icon}</span>
        <div class="file-info">
          <span class="file-name">${res.node.name}</span>
          <span class="file-path">${res.path}</span>
        </div>`;

      if (res.node.type === 'dir') {
        // ç‚¹å‡»æœç´¢åˆ°çš„æ–‡ä»¶å¤¹ï¼šè·³è½¬åˆ°è¯¥ç›®å½•å¹¶æ¢å¤æ­£å¸¸çš„åˆ—è¡¨è§†å›¾
        el.onclick = () => {
          // æ¸…ç©ºæœç´¢æ¡†
          document.getElementById('searchInput').value = '';
          isSearching = false;
          // é‡å»ºè·¯å¾„æ ˆï¼šçˆ¶çº§é“¾ + å½“å‰èŠ‚ç‚¹
          pathStack = [...res.parents, res.node];
          renderList();
        };
      } else {
        // ç‚¹å‡»æœç´¢åˆ°çš„æ–‡ä»¶ï¼šç›´æ¥é¢„è§ˆ
        el.onclick = () => enterPreview(res.node, res.path);
      }
      container.appendChild(el);
    });
  }

  // --- è¾…åŠ©åŠŸèƒ½ ---

  function renderBreadcrumb() {
    const header = document.getElementById('breadcrumb');
    header.innerHTML = '';
    
    const rootSpan = document.createElement('span');
    rootSpan.textContent = 'ğŸ  Root';
    rootSpan.className = pathStack.length === 0 ? '' : 'breadcrumb-item';
    if(pathStack.length > 0) rootSpan.onclick = () => { pathStack = []; renderList(); };
    header.appendChild(rootSpan);

    pathStack.forEach((node, index) => {
      const sep = document.createElement('span');
      sep.className = 'breadcrumb-separator';
      sep.textContent = '/';
      header.appendChild(sep);

      const span = document.createElement('span');
      span.textContent = node.name;
      if (index < pathStack.length - 1) {
        span.className = 'breadcrumb-item';
        span.onclick = () => {
          pathStack = pathStack.slice(0, index + 1);
          renderList();
        };
      }
      header.appendChild(span);
    });
  }

  async function handleReadmeInList(nodes) {
    const readmeNode = nodes.find(n => n.name.toLowerCase() === 'readme.md');
    const readmeBox = document.getElementById('readmeBox');
    const contentDiv = document.getElementById('readmeFooter');
    
    if (readmeNode) {
      const path = currentBasePath + readmeNode.name;
      try {
        const text = await fetch(path).then(r => r.text());
        contentDiv.innerHTML = marked.parse(text);
        readmeBox.classList.remove('hidden');
      } catch (e) {
        readmeBox.classList.add('hidden');
      }
    } else {
      readmeBox.classList.add('hidden');
      contentDiv.innerHTML = '';
    }
  }

  function enterFolder(node) {
    pathStack.push(node);
    renderList();
  }

  function goBackFolder() {
    pathStack.pop();
    renderList();
  }

  // --- é¢„è§ˆæ¨¡å¼ ---

  async function enterPreview(node, fullPath) {
    // éšè—åˆ—è¡¨ï¼Œæ˜¾ç¤ºé¢„è§ˆ
    document.getElementById('view-list').classList.add('hidden');
    document.getElementById('view-preview').classList.remove('hidden');

    document.getElementById('previewTitle').textContent = node.name;
    document.getElementById('downloadBtn').href = fullPath;

    const container = document.getElementById('previewContent');
    container.innerHTML = '<div style="text-align:center; padding: 20px;">æ­£åœ¨åŠ è½½é¢„è§ˆ...</div>';

    const ext = node.name.split('.').pop().toLowerCase();
    
    // ç®€å•çš„ç±»å‹åˆ¤æ–­
    if (['png', 'jpg', 'jpeg', 'gif', 'svg', 'webp'].includes(ext)) {
      container.innerHTML = `<img src="${fullPath}" class="preview-image">`;
    } else if (['mp4', 'webm'].includes(ext)) {
      container.innerHTML = `<div style="text-align:center"><video controls style="max-width:100%"><source src="${fullPath}"></video></div>`;
    } else if (['md', 'markdown'].includes(ext)) {
      try {
        const text = await fetch(fullPath).then(r => r.text());
        container.innerHTML = marked.parse(text);
      } catch (e) { container.innerHTML = 'åŠ è½½å¤±è´¥'; }
    } else if (['txt', 'js', 'json', 'css', 'html', 'py', 'java', 'c', 'cpp', 'h'].includes(ext)) {
      try {
        const text = await fetch(fullPath).then(r => r.text());
        const safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        container.innerHTML = `<pre class="preview-code"><code>${safeText}</code></pre>`;
      } catch (e) { container.innerHTML = 'åŠ è½½å¤±è´¥'; }
    } else {
      container.innerHTML = `<div style="text-align:center; margin-top:50px; color:#666;"><p>æ­¤æ–‡ä»¶ä¸æ”¯æŒåœ¨çº¿é¢„è§ˆ</p></div>`;
    }
  }

  function exitPreview() {
    document.getElementById('view-preview').classList.add('hidden');
    document.getElementById('previewContent').innerHTML = ''; // æ¸…ç†
    
    // å¦‚æœä¹‹å‰æ˜¯æœç´¢è¿›æ¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ç•™åœ¨æœç´¢ç»“æœï¼Œæˆ–è€…è¿”å›åˆ—è¡¨
    // è¿™é‡Œé€‰æ‹©è¿”å›åˆ°å½“å‰åˆ—è¡¨è§†å›¾
    if (isSearching) {
        // å¦‚æœæƒ³å›åˆ°æœç´¢ç»“æœï¼Œéœ€è¦æŠŠ fileList é‡æ–°æ¸²æŸ“æˆæœç´¢ç»“æœ
        // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åœ¨æœç´¢æ¨¡å¼ä¸‹è¿›å…¥æ–‡ä»¶å†è¿”å›æ—¶ï¼Œä¾ç„¶ä¿æŒæœç´¢çŠ¶æ€
        document.getElementById('view-list').classList.remove('hidden');
        // ä¸éœ€è¦é¢å¤–æ“ä½œï¼Œå› ä¸ºDOMæ²¡å˜
    } else {
        document.getElementById('view-list').classList.remove('hidden');
    }
  }

  init();
</script>

</body>
</html>